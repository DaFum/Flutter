<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web-App Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material-darker.min.css">  
  <style>
    :root {
      --primary-color: #4a76a8;
      --secondary-color: #6c5ce7;
      --background-color: #f0f2f5;
      --text-color: #333;
      --card-background: #ffffff;
      --input-background: #e0e0e0;
      --button-hover: #3b5f86;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      text-align: center;
      position: relative;
    }

    h1 {
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    #restart-onboarding {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
    }

    .card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background-color: var(--input-background);
      font-size: 16px;
      transition: var(--transition);
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--secondary-color);
    }

    textarea {
      min-height: 150px;
      resize: vertical;
    }

    .file-upload {
      display: inline-block;
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .file-upload input[type="file"] {
      position: absolute;
      font-size: 100px;
      right: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-upload label {
      display: inline-block;
      padding: 10px 20px;
      background-color: var(--secondary-color);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload label:hover {
      background-color: var(--button-hover);
    }

    #file-name {
      margin-left: 10px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      transition: var(--transition);
    }

    button:hover {
      background-color: var(--button-hover);
    }

    .editor-preview {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #code-editor-container,
    #preview-frame {
      width: 100%;
      height: 300px;
      border: none;
      border-radius: 4px;
      overflow: hidden;
    }

    #console-container {
      background-color: #1e1e1e;
      color: #ffffff;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      height: 150px;
      overflow-y: auto;
    }

    .dark-mode {
      --background-color: #1a1a1a;
      --text-color: #ffffff;
      --card-background: #2c2c2c;
      --input-background: #3a3a3a;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @media (min-width: 768px) {
      .editor-preview {
        flex-direction: row;
      }

      #code-editor-container,
      #preview-frame {
        flex: 1;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: var(--card-background);
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
    }

    .onboarding-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>  
  
</head>
<body>
  <header>
    <h1>Web-App Generator</h1>
    <button id="restart-onboarding" aria-label="Onboarding wiederholen">‚ùì</button>
  </header>

  <main class="container">
    <section class="card fade-in">
      <div class="input-group">
        <label for="user-input">Beschreibung oder √Ñnderungsanweisung:</label>
        <input type="text" id="user-input" placeholder="z.B.: Erstelle ein Anmeldeformular" aria-label="Beschreibung oder √Ñnderungsanweisung">
      </div>

      <div class="input-group">
        <label for="user-content">Content (z.B. Kursmaterial):</label>
        <textarea id="user-content" placeholder="F√ºge hier deinen Content ein..." aria-label="Content Eingabe"></textarea>
      </div>

      <div class="file-upload">
        <label for="file-input">Datei hochladen</label>
        <input type="file" id="file-input" accept=".txt,.pdf,.doc,.docx">
        <span id="file-name"></span>
      </div>

      <div class="input-group">
        <label for="prompt-select">Vordefinierte Aufgabe:</label>
        <select id="prompt-select">
          <option value="">-- Bitte w√§hlen --</option>
          <option value="Erstelle eine einfache ToDo-Liste">Einfache ToDo-Liste</option>
          <option value="Erstelle eine Galerie mit Bildern und Beschreibungen">Bildergalerie</option>
          <option value="Erstelle eine Kontaktformular-Seite mit Validierung">Kontaktformular</option>
        </select>
      </div>

      <div class="button-group">
        <button id="send-request" aria-label="Anfrage senden">üí° Anfrage senden</button>
        <button id="update-preview" aria-label="Vorschau aktualisieren">üîÑ Vorschau aktualisieren</button>
        <button id="toggle-dark-mode" aria-label="Dark Mode umschalten">üåô Dark Mode</button>
        <button id="download-code" aria-label="HTML herunterladen">üíæ Download HTML</button>
      </div>

      <div class="input-group">
        <label for="template-select">Template:</label>
        <select id="template-select">
          <option value="">-- Bitte w√§hlen --</option>
          <option value="Kurs-Website">Kurs-Website</option>
          <option value="Interaktive Quiz-App">Interaktive Quiz-App</option>
        </select>
      </div>
    </section>

    <section class="card fade-in">
      <button id="toggle-code-editor">Code Editor anzeigen/ausblenden</button>
      <div class="editor-preview">
        <div id="code-editor-container" style="display: block;">
          <textarea id="code-editor"></textarea>
        </div>
      </div>
    </section>
    
    <section class="card fade-in">
        <iframe id="preview-frame" title="Vorschau der generierten Web-App"></iframe>
    </section>

    <section class="card fade-in">
      <button id="toggle-console">Konsole anzeigen</button>
      <div id="console-container" style="display: none;"></div>
    </section>
  </main>

  <div id="onboarding-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Willkommen zum Web-App Generator!</h2>
      <div id="onboarding-content"></div>
      <div class="onboarding-nav">
        <button id="prev-step">Zur√ºck</button>
        <button id="next-step">Weiter</button>
      </div>
    </div>
  </div>

  <script>
    var apiKey;
    fetch('/api/getApiKey')
      .then(response => response.json())
      .then(data => {
        apiKey = data.apiKey;
      })
      .catch(error => console.error('Error fetching API key:', error));
    var apiUrl = 'https://api.together.xyz/v1/chat/completions';

    var templates = {
      "Kurs-Website": `<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kurs-Website</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background-color: #4a76a8; color: white; padding: 20px; text-align: center; }
    nav { background-color: #333; overflow: hidden; }
    nav a { float: left; display: block; color: white; text-align: center; padding: 14px 16px; text-decoration: none; }
    nav a:hover { background-color: #ddd; color: black; }
    main { padding: 20px; }
    footer { background-color: #f1f1f1; padding: 10px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Mein Kurs</h1>
  </header>
  <nav>
    <a href="#">Startseite</a>
    <a href="#">√úber den Kurs</a>
    <a href="#">Kontakt</a>
  </nav>
  <main>
    <h2>Willkommen zum Kurs!</h2>
    <p>Hier finden Sie alle Informationen zum Kurs.</p>
  </main>
  <footer>
    &copy; 2024 WBS Training AG
  </footer>
</body>
</html>`,

      "Interaktive Quiz-App": `<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Interaktive Quiz-App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #question { font-size: 20px; margin-bottom: 20px; }
    .option { display: block; margin-bottom: 10px; }
    #submit { padding: 10px 20px; font-size: 16px; }
    #result { margin-top: 20px; font-size: 18px; } 
  </style>
</head>
<body>
  <h1>Quiz</h1>
  <div id="quiz-container">
    <div id="question">Was ist  die Hauptstadt von Deutschland?</div>
    <label class="option"><input type="radio" name="option" value="Berlin"> Berlin</label>
    <label class="option"><input type="radio" name="option" value="M√ºnchen"> M√ºnchen</label>
    <label class="option"><input type="radio" name="option" value="Hamburg"> Hamburg</label>
    <button id="submit">Antwort senden</button>
    <div id="result"></div>
  </div>

  <script>
    document.getElementById("submit").addEventListener("click", function() {
      var options = document.getElementsByName("option");
      var selectedOption;
      for (var i = 0; i < options.length; i++) {
        if (options[i].checked) {
          selectedOption = options[i].value;
        }
      }
      if (selectedOption === "Berlin") {
        document.getElementById("result").innerText = "Richtig! Berlin ist die Hauptstadt von Deutschland.";
      } else {
        document.getElementById("result").innerText = "Falsch! Versuche es erneut.";
      }
    });
  <\/script>
</body>
</html>`,
    };

    var predefinedPrompts = {
      "Erstelle eine einfache ToDo-Liste": "Erstelle eine einfache ToDo-Liste mit der M√∂glichkeit, Aufgaben hinzuzuf√ºgen, abzuhaken und zu l√∂schen.",
      "Erstelle eine Galerie mit Bildern und Beschreibungen": "Erstelle eine Bildergalerie, in der Bilder mit Beschreibungen angezeigt werden und durchgeklickt werden k√∂nnen.",
      "Erstelle eine Kontaktformular-Seite mit Validierung": "Erstelle eine Kontaktseite mit einem Formular, das Felder f√ºr Name, E-Mail und Nachricht enth√§lt. F√ºge Validierungen f√ºr die Eingabefelder hinzu.",
    };

    var codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
      mode: 'htmlmixed',
      theme: 'default',
      lineNumbers: true,
      lineWrapping: true
    });

    codeEditor.setValue(`<!DOCTYPE html>
    <html lang="de">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Beispiel Web-App</title>
    </head>
    <body>
      <h1>Willkommen zur Web-App Generator</h1>
      <p>Hier wird Ihr generierter Code angezeigt.</p>
    </body>
    </html>`);
    codeEditor.refresh()
    preview-frame.refresh();

    document.getElementById('file-input').addEventListener('change', function(e) {
      var file = e.target.files[0];
      var fileName = file.name;
      document.getElementById('file-name').textContent = fileName;
      
      if (file.type === 'application/pdf') {
        var reader = new FileReader();
        reader.onload = function(e) {
          var typedarray = new Uint8Array(e.target.result);
          processPDF(typedarray);
        };
        reader.readAsArrayBuffer(file);
      } else {
        var reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('user-content').value = e.target.result;
        };
        reader.readAsText(file);
      }
    });

    function processPDF(data) {
      pdfjsLib.getDocument(data).promise.then(function(pdf) {
        var pagesPromises = [];

        for (var i = 1; i <= pdf.numPages; i++) {
          pagesPromises.push(getPageText(pdf, i));
        }

        Promise.all(pagesPromises).then(function(pagesText) {
          var text = pagesText.join(' ');
          document.getElementById('user-content').value = text;
        });
      });
    }

    function getPageText(pdf, pageNum) {
      return pdf.getPage(pageNum).then(function(page) {
        return page.getTextContent().then(function(textContent) {
          return textContent.items.map(function(item) {
            return item.str;
          }).join(' ');
        });
      });
    }

    document.getElementById('send-request').addEventListener('click', function() {
      var currentCode = codeEditor.getValue();
      var userInput = document.getElementById('user-input').value;
      var userContent = document.getElementById('user-content').value;

      if (userInput.trim() === '') {
        alert('Bitte gib eine Beschreibung oder √Ñnderungsanweisung ein.');
        return;
      }

      var systemMessage = "Du bist ein erfahrener Webentwickler, der HTML5, CSS und JavaScript beherrscht.";
      var userMessage = '';

      if (currentCode.trim() === '') {
        userMessage = `Erstelle ausschlie√ülich den vollst√§ndigen HTML5-Code f√ºr eine Web-App basierend auf folgender Beschreibung und Content:

Beschreibung: ${userInput}

Content:
${userContent}

Der Code sollte alle notwendigen HTML-, CSS- und JavaScript-Teile enthalten und als eine einzelne HTML-Datei ausf√ºhrbar sein. Integriere den bereitgestellten Content sinnvoll in die Web-App. Gib nur den Code zur√ºck, ohne zus√§tzliche Erkl√§rungen oder Kommentare. Verwende keine Formatierungen wie \`\`\`.`;
      } else {
        userMessage = `Passe den folgenden HTML5-Code basierend auf der unten stehenden Anforderung und dem bereitgestellten Content an.

Aktueller Code:

${currentCode}

Anforderung:
${userInput}

Content:
${userContent}

Gib ausschlie√ülich den vollst√§ndigen, aktualisierten HTML5-Code zur√ºck, ohne zus√§tzliche Erkl√§rungen oder Kommentare. Der Code sollte alle notwendigen HTML-, CSS- und JavaScript-Teile enthalten und als eine einzelne HTML-Datei ausf√ºhrbar sein. Integriere den bereitgestellten Content sinnvoll in die Web-App. Verwende keine Formatierungen wie \`\`\`.`;
      }

      fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "meta-llama/Llama-Vision-Free",
            messages: [
              { role: "system", content: systemMessage },
              { role: "user", content: userMessage }
            ],
            max_tokens: 2000,
            temperature: 0.7,
            stop: ["<|eot_id|>","<|eom_id|>"],
          })
      })
      .then(response => response.json())
      .then(data => {
        if (data.choices && data.choices.length > 0) {
          var generatedCode = data.choices[0].message.content.trim();
          generatedCode = generatedCode.replace(/^```(?:html)?\s*/, '').replace(/```$/, '');
          codeEditor.setValue(generatedCode);
        } else {
          console.error('Unerwartete API-Antwort:', data);
          alert('Es gab ein Problem mit der API-Antwort. Bitte versuche es erneut.');
        }
      })
      .catch(error => {
        console.error('Fehler bei der API-Anfrage:', error);
        alert('Es gab einen Fehler bei der API-Anfrage. Bitte √ºberpr√ºfe deine Internetverbindung und den API-Schl√ºssel.');
      });
    });

    document.getElementById('update-preview').addEventListener('click', function() {
      var code = codeEditor.getValue();
      var iframe = document.getElementById('preview-frame');
      
      try {
        iframe.srcdoc = code;
        iframe.onload = function() {
          try {
            iframe.contentWindow.eval('');
          } catch (error) {
            logToConsole('Error in preview: ' + error.message, true);
          }
        };
      } catch (error) {
        logToConsole('Error updating preview: ' + error.message, true);
      }
    });

    document.getElementById('toggle-console').addEventListener('click', function() {
      var consoleContainer = document.getElementById('console-container');
      if (consoleContainer.style.display === 'none' || consoleContainer.style.display === '') {
        consoleContainer.style.display = 'block';
        this.textContent = 'Konsole ausblenden';
      } else {
        consoleContainer.style.display = 'none';
        this.textContent = 'Konsole anzeigen';
      }
    });

    function logToConsole(message, isError = false) {
      var consoleOutput = document.getElementById('console-container');
      var logEntry = document.createElement('div');
      logEntry.textContent = message;
      if (isError) {
        logEntry.style.color = '#ff6b6b';
      }
      consoleOutput.appendChild(logEntry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    document.getElementById('toggle-dark-mode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      codeEditor.setOption('theme', document.body.classList.contains('dark-mode') ? 'material-darker' : 'default');
    });

    document.getElementById('download-code').addEventListener('click', function() {
      var code = codeEditor.getValue();
      if (code.trim() === '') {
        alert('Es gibt keinen Code zum Herunterladen.');
        return;
      }
      var blob = new Blob([code], { type: 'text/html' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'webapp.html';
      link.click();
    });

    document.getElementById('template-select').addEventListener('change', function() {
      var selectedTemplate = this.value;
      if (templates[selectedTemplate]) {
        codeEditor.setValue(templates[selectedTemplate]);
        document.getElementById('preview-frame').srcdoc = templates[selectedTemplate];
      }
    });

    document.getElementById('prompt-select').addEventListener('change', function() {
      var selectedPromptKey = this.value;
      if (predefinedPrompts[selectedPromptKey]) {
        document.getElementById('user-input').value = predefinedPrompts[selectedPromptKey];
      }
    });

     const onboardingSteps = [
      {
        title: "Beschreibung eingeben",
        content: "Gib eine Beschreibung oder √Ñnderungsanweisung ein, um deine Web-App zu erstellen oder zu bearbeiten."
      },
      {
        title: "Content hinzuf√ºgen",
        content: "F√ºge deinen Content (z.B. Kursmaterial) in das gro√üe Textfeld ein oder lade eine Datei hoch."
      },
      {
        title: "Vordefinierte Aufgaben",
        content: "W√§hle eine vordefinierte Aufgabe aus dem Dropdown-Men√º, um schnell mit einem bestimmten Projekt zu beginnen."
      },
      {
        title: "Anfrage senden",
        content: "Klicke auf 'Anfrage senden', um deine Web-App basierend auf deiner Beschreibung und deinem Content zu generieren."
      },
      {
        title: "Vorschau aktualisieren",
        content: "Nutze den 'Vorschau aktualisieren' Button, um die √Ñnderungen in Echtzeit zu sehen."
      },
      {
        title: "Dark Mode",
        content: "Schalte den Dark Mode ein oder aus, um die Benutzeroberfl√§che an deine Pr√§ferenzen anzupassen."
      },
      {
        title: "Code herunterladen",
        content: "Lade deinen generierten HTML-Code herunter, um ihn lokal zu speichern oder weiter zu bearbeiten."
      },
      {
        title: "Templates",
        content: "W√§hle ein vordefiniertes Template aus, um schnell mit einer bestimmten Art von Web-App zu beginnen."
      }
    ];

    let currentStep = 0;

    function showOnboarding() {
      const modal = document.getElementById('onboarding-modal');
      const content = document.getElementById('onboarding-content');
      const prevBtn = document.getElementById('prev-step');
      const nextBtn = document.getElementById('next-step');

      modal.style.display = 'block';
      updateOnboardingContent();

      document.querySelector('.close').onclick = function() {
        modal.style.display = 'none';
      }

      prevBtn.onclick = function() {
        if (currentStep > 0) {
          currentStep--;
          updateOnboardingContent();
        }
      }

      nextBtn.onclick = function() {
        if (currentStep < onboardingSteps.length - 1) {
          currentStep++;
          updateOnboardingContent();
        } else {
          modal.style.display = 'none';
          currentStep = 0;
        }
      }
    }

    function updateOnboardingContent() {
      const content = document.getElementById('onboarding-content');
      const prevBtn = document.getElementById('prev-step');
      const nextBtn = document.getElementById('next-step');

      content.innerHTML = `
        <h3>${onboardingSteps[currentStep].title}</h3>
        <p>${onboardingSteps[currentStep].content}</p>
      `;

      prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
      nextBtn.textContent = currentStep === onboardingSteps.length - 1 ? 'Fertig' : 'Weiter';
    }

    window.onload = showOnboarding;

    document.getElementById('toggle-code-editor').textContent = 'Code Editor ausblenden';
    document.getElementById('toggle-code-editor').addEventListener('click', function() {
      var codeEditorContainer = document.getElementById('code-editor-container');
      if (codeEditorContainer.style.display === 'none') {
        codeEditorContainer.style.display = 'block';
        this.textContent = 'Code Editor ausblenden';
      } else {
        codeEditorContainer.style.display = 'none';
        this.textContent = 'Code Editor anzeigen';
      }
      codeEditor.refresh();
    });

    document.getElementById('restart-onboarding').addEventListener('click', function() {
      currentStep = 0;
      showOnboarding();
    });
  </script>
</body>
</html>